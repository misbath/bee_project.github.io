---
title: "Bee and Pesticide Change Over the Years"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
runtime: shiny
---

```{r setup, include=FALSE}
library(flexdashboard)
library(shiny)
library(plotly)
library(tidyverse)

```

# if we would like to toggle between honey bee and all bee, need to merge the datasets and add differentiating factor... this gets more complicated

honey_bee_data = 
  full_join(county_bee_yrfips, state_bee_yrfips, by = "state_year_fips")

all_bee_data %>%
  mutate(bee_type = if_else(production_value >= 0, "honey_bee", "bee"))


```{r}
#create function to import data
file_name <- list.files(path = "./data/bee_state_2/") 

df = read_csv(file = str_c("./data/bee_state_2/", file_name[1])) %>%
  mutate(file = file_name[1])
  df
  
my_read_csv = function(x){
    df = read_csv(x, skip = 9, col_names  = F)
}
  
bee_data = 
  tibble(
    file_names = file_name,
    path = str_c("./data/bee_state_2/", file_names)
  ) %>% 
  mutate(data = map(path, my_read_csv))%>% 
  unnest()

#clean data set
shiny_bee_data =
  bee_data %>%
 separate(file_names, into = c("year", "remove"), sep = ".c") %>%
  select(-remove, -X1, -X2, -path) %>%
  rename(state = X3, honey_producing_colonies = X4, yield_per_colony = X5, production = X6, stocks = X7, price_per_pound = X8, production_value = X9) %>%
  mutate(state = recode(state, AL = "Alabama", AR = "Arkansas", AZ = "Arizona", CA = "California", CO = "Colorado", FL = "Florida", GA = "Georgia", HI = "Hawaii", IA = "Iowa", IL = "Illinois", ID = "Idaho", IN = "Indiana", KS = "Kansas", KY = "Kentucky", LA = "Louisiana", ME = "Maine", MD = "Maryland", MI = "Michigan", MN = "Minnesota", MO = "Missouri", MT = "Montana", MS = "Mississippi", NC = "North Carolina", ND = "North Dakota", NE = "Nebraska", NJ = "New Jersey", NM = "New Mexico", NV = "Nevada", NY = "New York", OH = "Ohio", OK = "Oklahoma", OR = "Oregon", PA = "Pennsylvania", SC = "South Carolina", SD = "South Dakota", TN = "Tennessee", TX = "Texas", UT = "Utah", VA = "Virginia", VT = "Vermont", WA = "Washington", WV = "West Virginia", WI = "Wisconsin", WY = "Wyoming")) %>%
  select(year, state, honey_producing_colonies) %>%
  filter(!is.na(honey_producing_colonies)) 
```

shiny_bee_data %>%
  group_by(state) %>%
  summarise(n = n()) %>%
  view()

Bee Population Map
===================================== 

Column {.sidebar}
-----------------------------------------------------------------------

```{r}
# entries to select from
year <- c(2002:2002)

# year select box 
selectInput("year_1", label = h3("Choose year"),
						choices = year,
						selected = 2002)

# bee data select box
#ONLY IF WE WANT TO MERGE DATASETS
#selectInput("bee_type", label = h3("Choose variable"),
					#	choices = type_variable, selected = "Honey Bee")
```

Column {.tabset}
-----------------------------------------------------------------------

### US MAP

```{r}
# this chunk of code should not change.. directly copy and pasted from the example shiny. sets the parameters for the way in which the US will appear in the dashboard
# plot_geo
renderPlotly({
	# map plot setting
	geo1 <- list(
	scope = "usa",
	projection = list(type = "state"),
	showlakes = TRUE,
	lakecolor = toRGB("white")
	)

shiny_bee_data %>% 
	filter(year == input$year_1) %>% 
	plot_geo(locationmode = "USA-states") %>% 
	add_trace(
		z = ~honey_producing_colonies,
		locations = ~state,
		color = ~honey_producing_colonies,
		colors = "Reds",
		# add text
		text = ~paste(year, state, sep = "")
		) %>%
	layout(
		geo = geo1,
		title = "US Map - State Bee Population",
		legend = list(x = 100, y = 0.5)
	)
})

# rsconnect::deployApp("./zanis_shiny.Rmd")

```
# display value using color intensity
shiny_bee_data %>% 
	plot_geo(locationmode = "USA-states") %>% 
	add_trace(
		z = ~honey_producing_colonies,
		locations = ~state,
		color = ~honey_producing_colonies,
		colors = "Reds",
		# add text
		text = ~paste(honey_producing_colonies, state)
		) %>%
	layout(
		geo = geo1,
		title = "US Map - Bee Population",
		legend = list(x = 100, y = 0.5)
	)
})

## Unused code
==========================================
  
#pivot_wider(names_from = year, values_from =   honey_producing_colonies) 

#mutate(to_fill = if_else(is.na(honey_producing_colonies), 0, honey_producing_colonies)) %>%
	#spread(key = year, value = honey_producing_coloniesl) %>% 
	#gather(key = year, value = honey_producing_colonies, year_2002:year_2019) %>%
	#mutate(year = as.numeric(str_extract(year, "[0-9]{4}")))

library(maps)
mapStates = map("state", fill = TRUE, plot = FALSE)

leaflet(data = mapStates) %>%
  addTitles() %>%
  addPolygons(fillColor)



#if shiny doesn't work should we create more simple interactive map?

state_bee_fips %>%
  ggplot(aes(long, lat, group = state, fill = honey_producing_colonies)) +
  geom_polygon(color = NA) +
  coord_map(projection = "albers", lat0 = 39, lat1 = 45) +
  labs(fill = "Honey Producing Colonies")

## Standard map of US

install.package("devtools")
devtools::install_github("pdil/usmap")

library(usmap)
library(ggplot2)

shiny_bee_data %>%
plot_usmap(regions = "states", values = honey_producing_colonies, color = "red") + 
    scale_fill_continuous(
    low = "white", high = "red", name = "Population (2015)", label = scales::comma
  ) + theme(legend.position = "right")

library(map)

install.packages(c("ggplot2", "devtools", "dplyr", "stringr"))
install.packages(c("maps", "mapdata"))
devtools::install_github("dkahle/ggmap")

library(ggplot2)
library(ggmap)
library(maps)
library(mapdata)

states <- map_data("state") %>%
  group_by(region)
dim(states)

shiny_bee_data %>%
  filter( year == 2002) %>%
ggplot(data = shiny_bee_data) + 
  geom_polygon(aes(x = long, y = lat, fill = honey_producing_colonies, group = group), color = "white") + 
  coord_fixed(1.3)


